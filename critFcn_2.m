function [critFcnVal] = critFcn_2(ksi)
warning('off','all')
% optimalizovane parametry
% ksi = [L1;L2;L3];
%[time_length, cesta] = create_traj(trajectory);
c = clock;
%disp(c)
time_length = 121;

cesta = [1 0 1.50000000000000 1.00333333333333 0.100000000000000 1.50000000000000 1.01333333333333 0.200000000000000 1.50000000000000 1.02344827586207 0.200000000000000 0 1.03356321839080 0.200000000000000 0 1.04367816091954 0.200000000000000 0 1.05379310344828 0.200000000000000 0 1.06390804597701 0.200000000000000 0 1.07402298850575 0.200000000000000 0 1.08413793103448 0.200000000000000 0 1.09425287356322 0.200000000000000 0 1.10436781609195 0.200000000000000 0 1.11448275862069 0.200000000000000 0 1.12459770114943 0.200000000000000 0 1.13471264367816 0.200000000000000 0 1.14482758620690 0.200000000000000 0 1.15494252873563 0.200000000000000 0 1.16505747126437 0.200000000000000 0 1.17517241379310 0.200000000000000 0 1.18528735632184 0.200000000000000 0 1.19540229885057 0.200000000000000 0 1.20551724137931 0.200000000000000 0 1.21563218390805 0.200000000000000 0 1.22574712643678 0.200000000000000 0 1.23586206896552 0.200000000000000 0 1.24597701149425 0.200000000000000 0 1.25609195402299 0.200000000000000 0 1.26620689655172 0.200000000000000 0 1.27625535406975 0.193806940615389 -0.377049661739319 1.28537221667691 0.163195533063098 -0.795599007762803 1.29250255674476 0.117165449446058 -0.986788215209673 1.29715735022043 0.0672153634393643 -0.950617284079789 1.29942911516798 0.0248439487181903 -0.687086214373052 1.29999191176830 0.00154987895770849 -0.196195006089359 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.29976203401020 -0.0141821397110107 -0.545279722880726 1.29817780125632 -0.0513417330689663 -0.886319930745180 1.29437499984488 -0.100000000101621 -1.00000000003072 1.28806285871747 -0.148658267134427 -0.886319930738915 1.27953214893250 -0.185817860491625 -0.545279722871379 1.26965517241379 -0.200000000000000 0 1.25954022988506 -0.200000000000000 0 1.24942528735632 -0.200000000000000 0 1.23931034482759 -0.200000000000000 0 1.22919540229885 -0.200000000000000 0 1.21908045977012 -0.200000000000000 0 1.20896551724138 -0.200000000000000 0 1.19885057471264 -0.200000000000000 0 1.18873563218391 -0.200000000000000 0 1.17862068965517 -0.200000000000000 0 1.16850574712644 -0.200000000000000 0 1.15839080459770 -0.200000000000000 0 1.14827586206897 -0.200000000000000 0 1.13816091954023 -0.200000000000000 0 1.12804597701149 -0.200000000000000 0 1.11793103448276 -0.200000000000000 0 1.10781609195402 -0.200000000000000 0 1.09770114942529 -0.200000000000000 0 1.08758620689655 -0.200000000000000 0 1.07747126436782 -0.200000000000000 0 1.06735632183908 -0.200000000000000 0 1.05724137931034 -0.200000000000000 0 1.04712643678161 -0.200000000000000 0 1.03701149425287 -0.200000000000000 0 1.02690463705494 -0.198450122500011 0.196195005271572 1.01735249105332 -0.175156052782465 0.687086213506518 1.00950931339412 -0.132784638104567 0.950617283251935 1.00404916426214 -0.0828345521373800 0.986788214455474 1.00106456171761 -0.0368044685565110 0.795599007064892 1.00006648171438 -0.00619306103969090 0.377049661027437 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0;1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0 0 1.00006648497883 0.00619305932760502 0.377049661652513 1.00106456489739 0.0368044668754048 0.795599007671209 1.00404916735505 0.0828345504876893 0.986788215113153 1.00950931640466 0.132784636489343 0.950617283978229 1.01735249398210 0.175156051205249 0.687086214266325 1.02690463990650 0.198450120960236 0.196195005977314 1.03701149425287 0.200000000000000 0 1.04712643678161 0.200000000000000 0 1.05724137931034 0.200000000000000 0 1.06735632183908 0.200000000000000 0 1.07747126436782 0.200000000000000 0 1.08758620689655 0.200000000000000 0 1.09770114942529 0.200000000000000 0 1.10781609195402 0.200000000000000 0 1.11793103448276 0.200000000000000 0 1.12804597701149 0.200000000000000 0 1.13816091954023 0.200000000000000 0 1.14827586206897 0.200000000000000 0 1.15839080459770 0.200000000000000 0 1.16850574712644 0.200000000000000 0 1.17862068965517 0.200000000000000 0 1.18873563218391 0.200000000000000 0 1.19885057471264 0.200000000000000 0 1.20896551724138 0.200000000000000 0 1.21908045977012 0.200000000000000 0 1.22919540229885 0.200000000000000 0 1.23931034482759 0.200000000000000 0 1.24942528735632 0.200000000000000 0 1.25954022988506 0.200000000000000 0 1.26965517241379 0.200000000000000 0 1.27953214904960 0.185817860306997 -0.545279722964349 1.28806285882513 0.148658266944797 -0.886319930833654 1.29437499994310 0.0999999999075953 -1.00000000012450 1.29817780134488 0.0513417328699385 -0.886319930838201 1.29976203408842 0.0141821395077386 -0.545279722976577 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.30000000000000 0 0 1.29999192013202 -0.00154987405433834 -0.196195003620333 1.29942912378192 -0.0248439436869982 -0.687086211826277 1.29715735909213 -0.0672153582794029 -0.950617281542388 1.29250256588239 -0.117165444159279 -0.986788212716622 1.28537222608611 -0.163195527651017 -0.795599005296632 1.27625536375490 -0.193806935078101 -0.377049659229467 1.26620689655172 -0.200000000000000 0 1.25609195402299 -0.200000000000000 0 1.24597701149425 -0.200000000000000 0 1.23586206896552 -0.200000000000000 0 1.22574712643678 -0.200000000000000 0 1.21563218390805 -0.200000000000000 0 1.20551724137931 -0.200000000000000 0 1.19540229885057 -0.200000000000000 0 1.18528735632184 -0.200000000000000 0 1.17517241379310 -0.200000000000000 0 1.16505747126437 -0.200000000000000 0 1.15494252873563 -0.200000000000000 0 1.14482758620690 -0.200000000000000 0 1.13471264367816 -0.200000000000000 0 1.12459770114943 -0.200000000000000 0 1.11448275862069 -0.200000000000000 0 1.10436781609195 -0.200000000000000 0 1.09425287356322 -0.200000000000000 0 1.08413793103448 -0.200000000000000 0 1.07402298850575 -0.200000000000000 0 1.06390804597701 -0.200000000000000 0 1.05379310344828 -0.200000000000000 0 1.04367816091954 -0.200000000000000 0 1.03356321839080 -0.200000000000000 0 1.02344827586207 -0.200000000000000 0 1.01333333333333 -0.200000000000000 1.50000000000000 1.00333333333333 -0.0999999999999990 1.50000000000000 0.999999999999999 6.24500451351651e-16 1.50000000000000;0 0 1.96349540849362 0.00436332312998582 0.130899693899575 1.96349540849362 0.0174532925199433 0.261799387799149 1.96349540849362 0.0306937213281761 0.261799387799149 1.04564665897544e-19 0.0439341501364090 0.261799387799149 -1.08394059083147e-19 0.0571745789446419 0.261799387799149 0 0.0704150077528747 0.261799387799149 4.88501331646576e-19 0.0836554365611075 0.261799387799149 3.63656176099859e-19 0.0968958653693404 0.261799387799149 3.58372704865393e-19 0.110136294177573 0.261799387799150 -3.81918933573421e-19 0.123376722985806 0.261799387799149 -1.01567879759305e-20 0.136617151794039 0.261799387799150 -9.06286910464625e-19 0.149857580602272 0.261799387799150 4.32464026094240e-19 0.163098009410505 0.261799387799150 4.32239627009337e-19 0.176338438218738 0.261799387799150 -6.11004499491854e-19 0.189578867026970 0.261799387799149 2.25015296235302e-19 0.202819295835203 0.261799387799149 -5.91893105547204e-19 0.216059724643436 0.261799387799149 -4.31152703466771e-19 0.229300153451669 0.261799387799149 -8.61667400653013e-19 0.242540582259902 0.261799387799150 0 0.255781011068135 0.261799387799149 9.34448329666457e-19 0.269021439876367 0.261799387799149 1.86108721006418e-18 0.282261868684600 0.261799387799150 -1.83478293707753e-18 0.295502297492833 0.261799387799150 -2.90091835949078e-18 0.308742726301066 0.261799387799149 1.06691716830625e-18 0.321983155109299 0.261799387799150 -1.11228415746223e-18 0.335223583917532 0.261799387799149 6.04791738300248e-19 0.348464012725765 0.261799387799150 -3.48640056423049e-19 0.361704441523128 0.261799387778820 -3.13357521478715e-11 0.374944870330292 0.261799387777227 -3.16716588656783e-11 0.388185299137376 0.261799387775602 -3.27416484910485e-11 0.401425727944375 0.261799387773909 -3.41435294953382e-11 0.414666156751287 0.261799387772166 -3.45833287569673e-11 0.427906585558111 0.261799387770422 -3.44900744349929e-11 0.441147014383394 0.261799387799149 4.97268844248001e-19 0.454387443191627 0.261799387799149 8.45072561113600e-19 0.467627871999860 0.261799387799149 1.52781439955861e-18 0.480868300808093 0.261799387799149 1.65231932848688e-18 0.494108729616326 0.261799387799149 -1.69689836850161e-18 0.507349158424559 0.261799387799149 0 0.520589587232791 0.261799387799149 -1.67628784193475e-18 0.533830016041024 0.261799387799149 1.56885985806414e-19 0.547070444849257 0.261799387799149 0 0.560310873657490 0.261799387799149 2.17018722128559e-18 0.573551302465723 0.261799387799149 2.98863752798236e-19 0.586791731273956 0.261799387799149 0 0.600032160082188 0.261799387799149 3.93453562902986e-19 0.613272588890421 0.261799387799149 1.21308246033848e-18 0.626513017698654 0.261799387799149 -4.87974398082443e-19 0.639753446506887 0.261799387799149 -3.82866021508149e-18 0.652993875315120 0.261799387799149 5.82409688229838e-19 0.666234304123353 0.261799387799149 -3.90831340594759e-18 0.679474732931586 0.261799387799149 -9.58827651310426e-19 0.692715161739818 0.261799387799149 -3.26341542745690e-18 0.705955590548051 0.261799387799149 -7.70957430886543e-19 0.719196019356284 0.261799387799149 4.06555048708898e-18 0.732436448164517 0.261799387799149 1.61969088123054e-18 0.745676876972750 0.261799387799149 -1.61554306056383e-18 0.758294336682128 0.224671287546678 -1.42756337802321 0.767387233734499 0.127385638808912 -2.32040049009062 0.770671898298415 -3.97031882276856e-11 -2.61793604933574 0.767387233731193 -0.127385638894583 -2.32040049030241 0.758294336673430 -0.224671287645758 -1.42756337836308 0.745676876972750 -0.261799387799149 2.52756375213475e-18 0.732436448164517 -0.261799387799149 1.61969088123054e-18 0.719196019356284 -0.261799387799149 8.18015055933887e-19 0.705955590548052 -0.261799387799149 -7.70957430886544e-19 0.692715161739819 -0.261799387799149 -9.07841696701235e-19 0.679474732931586 -0.261799387799149 0 0.666234304123353 -0.261799387799149 -2.89854182264289e-18 0.652993875315120 -0.261799387799149 -1.06067125996033e-18 0.639753446506887 -0.261799387799149 5.35203771365043e-19 0.626513017698655 -0.261799387799149 -1.65030332423893e-18 0.613272588890422 -0.261799387799149 -1.65380609864598e-18 0.600032160082189 -0.261799387799149 2.05068995446601e-18 0.586791731273956 -0.261799387799149 2.35292653980674e-18 0.573551302465723 -0.261799387799149 5.97727505596474e-19 0.560310873657490 -0.261799387799149 2.51548163693052e-19 0.547070444849257 -0.261799387799149 2.07867288925719e-18 0.533830016041024 -0.261799387799149 1.83018146926209e-18 0.520589587232791 -0.261799387799149 -3.46211922966117e-18 0.507349158424559 -0.261799387799149 0 0.494108729616326 -0.261799387799149 -1.69689836850161e-18 0.480868300808093 -0.261799387799149 1.65231932848688e-18 0.467627871999860 -0.261799387799149 -1.68752134472724e-18 0.454387443191627 -0.261799387799149 0 0.441147014383395 -0.261799387799149 2.18996366985190e-18 0.427906592118774 -0.261799384968817 3.58879451434553e-10 0.414666163454145 -0.261799384950577 3.62419499523664e-10 0.401425734790443 -0.261799384932136 3.67132559485957e-10 0.388185306127681 -0.261799384913413 3.73485375621384e-10 0.374944877465873 -0.261799384894353 3.80221082521542e-10 0.361704448805039 -0.261799384874955 3.86974013196345e-10 0.348464012725764 -0.261799387799150 -3.48640056423049e-19 0.335223583917532 -0.261799387799149 1.45999826760305e-18 0.321983155109299 -0.261799387799150 -2.56138428749647e-19 0.308742726301066 -0.261799387799149 -6.47177643206051e-19 0.295502297492833 -0.261799387799150 -3.27183796743906e-19 0.282261868684600 -0.261799387799150 -9.76044900758168e-19 0.269021439876367 -0.261799387799149 1.86108721006418e-18 0.255781011068134 -0.261799387799149 9.34448329666455e-19 0.242540582259902 -0.261799387799150 -8.60991630007512e-19 0.229300153451669 -0.261799387799149 -8.61667400653013e-19 0.216059724643436 -0.261799387799149 0 0.202819295835203 -0.261799387799150 1.13391813622709e-18 0.189578867026970 -0.261799387799149 -2.06718711868803e-19 0.176338438218737 -0.261799387799150 -6.11004499491853e-19 0.163098009410505 -0.261799387799150 0 0.149857580602272 -0.261799387799150 0 0.136617151794039 -0.261799387799149 -3.50773536791955e-19 0.123376722985806 -0.261799387799149 4.22699166379336e-19 0.110136294177573 -0.261799387799150 -1.65407200396260e-19 0.0968958653693400 -0.261799387799150 2.16586000099921e-19 0.0836554365611078 -0.261799387799149 3.63656176099860e-19 0.0704150077528749 -0.261799387799149 2.71795277535024e-19 0.0571745789446415 -0.261799387799149 -2.16751835938809e-19 0.0439341501364090 -0.261799387799149 -1.08394059083147e-19 0.0306937213281761 -0.261799387799149 1.04564665897544e-19 0.0174532925199431 -0.261799387799149 1.96349540849362 0.00436332312998244 -0.130899693899573 1.96349540849362 -1.33226762955019e-15 8.17469179220773e-16 1.96349540849362];

signals = struct;
for i = 1:time_length
   signals.values(:,:,i) = cesta(:,i+(2*(i-1)):i+(2*(i-1))+2); 
    
    
end
% vyber reseni - mozno take optimalizovat... reseni IGM
sol = -1;

% endEff_force_moment
endEff_force_moment = [0;0;0;0;0;0];

% DH parametry
% DHpar = [d_1,theta_1,a_1,alpha_1; d_2,theta_2,a_2,alpha_2;... ]
DHpar = [0,0,ksi(1),0;0,0,ksi(2),0;0,0,ksi(3),0];

% typy kloubu
% jointType = [joint1, joint2,...] => kl. sour: [q1; q2; ...]
jointType = ['R','R','R'];

% domovska poloha - hodnoty kl. souradnic pro sestaveni modelu v SimMech
% Qhome = [q1h; q2h; ...]
Qhome = [0;0;0];

% kompenzace polohy koncoveho efektoru
% endEffComp = [Oen,Ren]
Ren = EulerAnglesXYZ2rotMatrix([0;0;0]);
Oen = [0;0;0];

endEffComp = [Oen,Ren];

% kompenzace polohy zakladny
% baseComp = [O0b,R0b]
R0b = EulerAnglesXYZ2rotMatrix([0;0;0]);
O0b = [0;0;0];

baseComp = [O0b,R0b];

% DYNAMICKE PARAMETRY MANIPULATORU + PARAMETRY POHONU
% Pozn.: bez uvazovani dynamickeho chovani rotoru motoru !!! (nekdy dodelat)

% model ramene robotu - plna tyc delky L, prumeru d, hustoty rho a s motorem o hmotnosti M
d = 0.03;
rho = 7800;

M1 = 1.5; % hmotnost 1. motoru
[m1,T1,I1] = simpleLinkDynPar(ksi(1),d,rho,M1);
M2 = 1; % hmotnost 2. motoru
[m2,T2,I2] = simpleLinkDynPar(ksi(2),d,rho,M2);
M3 = 0.5; % hmotnost 3. motoru
[m3,T3,I3] = simpleLinkDynPar(ksi(3),d,rho,M3);

% hmotnosti ramen Link1, Link2,...
% mass = [m1; m2; ...]
mass = [m1;m2;m3];

% moment setrvacnosti ramen Link1, Link2,... vyjadrena v s.s. daneho ramene
%   F1, F2, ...
%   => inertiaTensor = [I1, I2, ...] ... konstantni (nezavisi na poloze manip.!)
inertiaTensor = [I1,I2,I3];

% umisteni tezist ramen Link1, Link2, ... vyjadrena v s.s. daneho ramene
%   F1, F2, ...
%   => gravityCenter = [T1, T2, ...] ... konstantni (nezavisi na poloze
%   manip.!)
gravityCenter = [T1,T2,T3];


% gravitacni vektor v s.s. F0
gravityVector = [0;-9.81;0];

kinPar{1}.DHpar = DHpar;
kinPar{1}.jointType = jointType;
kinPar{1}.Qhome = Qhome;
kinPar{1}.endEffComp = endEffComp;
kinPar{1}.baseComp = baseComp;

dynPar{1}.mass = mass;
dynPar{1}.inertiaTensor = inertiaTensor;
dynPar{1}.gravityCenter = gravityCenter;
dynPar{1}.gravityVector = gravityVector;

% silove momenty aktuatoru podel trajektorie
for i = 1:time_length
    
    jointCoords = inverseKinematics_2(signals.values(:,:,i),kinPar{1},sol);
    tau(:,i) = inverseDynamicModel(jointCoords,endEff_force_moment,kinPar{1},dynPar{1});
    tau_norm(i) = norm(tau(:,i));
end

% mira optimality (max. moment, prum. moment,...)
[critFcnVal] = max(tau_norm); % maximalni norma momentu podel trajektorie


